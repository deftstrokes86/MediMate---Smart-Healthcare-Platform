rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }
    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    // Private KYC documents per-user
    match /private/kyc/{uid}/{file} {
      // Allow upload by owner or admin, enforce type and size limits:
      allow write: if (isOwner(uid) || isAdmin())
                   && request.resource.size <= 10 * 1024 * 1024  // 10 MB
                   && (
                     request.resource.contentType.matches('application/pdf') ||
                     request.resource.contentType.matches('image/(png|jpeg|jpg)')
                   );

      // Allow read only for owner or admin
      allow read: if isOwner(uid) || isAdmin();
    }

    // Organization private docs (e.g., CAC for hospital or pharmacy chain)
    match /private/orgs/{orgId}/{file} {
      allow write: if isAdmin(); // only admin or backend should write org-level docs initially
      allow read: if isAdmin();
    }
  }
}