
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Default deny all
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // KYC documents can only be written by the owner or an admin
    // Files must be under 10MB and be of an accepted image or PDF type.
    match /private/kyc/{userId}/{fileName} {
      allow write: if request.auth != null 
                   && (request.auth.uid == userId || request.auth.token.role == 'admin' || request.auth.token.role == 'super_admin')
                   && request.resource.size < 10 * 1024 * 1024
                   && request.resource.contentType.matches('image/jpeg|image/png|application/pdf');
      
      // No public reads are allowed. All reads must use signed URLs generated by a Cloud Function.
      allow read: if false;
    }
    
    // Organization documents (e.g., CAC certificates)
    match /private/orgs/{orgId}/{fileName} {
       allow write: if request.auth != null 
                   && (request.auth.token.role == 'admin' || request.auth.token.role == 'super_admin');
                   
       allow read: if false; // Must use signed URLs
    }
  }
}
